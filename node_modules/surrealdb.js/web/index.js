var a=class extends Error{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"NoActiveSocket"}),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:"No socket is currently connected to a SurrealDB instance. Please call the .connect() method first!"})}},o=class extends Error{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"NoConnectionDetails"}),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:"No connection details for the HTTP api have been provided. Please call the .connect() method first!"})}},l=class extends Error{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"UnexpectedResponse"}),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:"The returned response from the SurrealDB instance is in an unexpected format. Unable to process response!"})}},u=class extends Error{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"InvalidURLProvided"}),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:"The provided string is either not a URL or is a URL but with an invalid protocol!"})}};var c=class{constructor(e=3e4){Object.defineProperty(this,"pinger",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"interval",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.interval=e}start(e){this.pinger=setInterval(e,this.interval)}stop(){clearInterval(this.pinger)}};var n;(function(s){s[s.OPEN=0]="OPEN",s[s.CLOSED=1]="CLOSED",s[s.RECONNECTING=2]="RECONNECTING"})(n||(n={}));var p=typeof WebSocket<"u"?WebSocket:null;var m=0;function v(){return(m=(m+1)%Number.MAX_SAFE_INTEGER).toString()}function h(s,e){let{protocol:t,host:r}=g(s);if(!Object.entries(e).flat().map(f=>f.toLowerCase()).includes(t))throw new u;return O(t,r,e)}function g(s){let e=/^([^/:]+):\/\/([^/]+)/,t=s.match(e);if(!t)throw new u;let[r,i]=[...t].slice(1,3).map(f=>f.toLowerCase());return{protocol:r,host:i}}function O(s,e,t){return s=s in t?t[s]:s,`${s}://${e}`}var d=class{constructor({url:e,onOpen:t,onClose:r}){Object.defineProperty(this,"url",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onOpen",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onClose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ws",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:n.CLOSED}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"ready",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resolveReady",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"closed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resolveClosed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"socketClosureReason",{enumerable:!0,configurable:!0,writable:!0,value:{1e3:"CLOSE_NORMAL"}}),this.resolveReady=()=>{},this.ready=new Promise(i=>this.resolveReady=i),this.resolveClosed=()=>{},this.closed=new Promise(i=>this.resolveClosed=i),this.onOpen=t,this.onClose=r,this.url=h(e,{http:"ws",https:"wss"})+"/rpc"}open(){this.close(1e3),this.resetReady(),this.ws=new p(this.url),this.ws.addEventListener("open",e=>{this.status=n.OPEN,this.resolveReady(),this.onOpen?.()}),this.ws.addEventListener("close",e=>{this.resolveClosed(),this.resetClosed(),this.status!==n.CLOSED&&(this.status=n.RECONNECTING,setTimeout(()=>{this.open()},2500),this.onClose?.())}),this.ws.addEventListener("message",e=>{let t=JSON.parse(e.data.toString());t.id&&t.id in this.queue&&(this.queue[t.id](t),delete this.queue[t.id])})}async send(e,t,r){await this.ready;let i=v();this.queue[i]=r,this.ws?.send(JSON.stringify({id:i,method:e,params:t}))}async close(e){this.status=n.CLOSED,this.ws?.close(e,this.socketClosureReason[e]),this.onClose?.(),await this.closed}get connectionStatus(){return this.status}resetReady(){this.ready=new Promise(e=>this.resolveReady=e)}resetClosed(){this.closed=new Promise(e=>this.resetClosed=e)}};var b=class{constructor(e,t={}){Object.defineProperty(this,"socket",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pinger",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ready",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resolveReady",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.resolveReady=()=>{},this.ready=new Promise(r=>this.resolveReady=r),e&&this.connect(e,t)}connect(e,{prepare:t}={}){this.socket?.close(1e3),this.pinger=new c(3e4),this.socket=new d({url:e,onOpen:async()=>{this.pinger?.start(()=>this.ping()),await t?.(this),this.resolveReady()},onClose:()=>{this.pinger?.stop(),this.resetReady()}}),this.socket.open()}async close(){await this.socket?.close(1e3),this.socket=void 0}async wait(){if(!this.socket)throw new a;await this.ready}get status(){if(!this.socket)throw new a;return this.socket.connectionStatus}async ping(){let{error:e}=await this.send("ping");if(e)throw new Error(e.message)}async use(e,t){let{error:r}=await this.send("use",[e,t]);if(r)throw new Error(r.message)}async info(){let e=await this.send("info");if(e.error)throw new Error(e.error.message)}async signup(e){let t=await this.send("signup",[e]);if(t.error)throw new Error(t.error.message);return t.result}async signin(e){let t=await this.send("signin",[e]);if(t.error)throw new Error(t.error.message);return t.result}async authenticate(e){let t=await this.send("authenticate",[e]);if(t.error)throw new Error(t.error.message)}async invalidate(){let e=await this.send("invalidate");if(e.error)throw new Error(e.error.message)}async let(e,t){let r=await this.send("let",[e,t]);if(r.error)throw new Error(r.error.message);return r.result}async query(e,t){await this.ready;let r=await this.send("query",[e,t]);if(r.error)throw new Error(r.error.message);return r.result}async select(e){await this.ready;let t=await this.send("select",[e]);return this.outputHandler(t,e)}async create(e,t){await this.ready;let r=await this.send("create",[e,t]);return this.outputHandler(r,e)}async update(e,t){await this.ready;let r=await this.send("update",[e,t]);return this.outputHandler(r,e)}async change(e,t){await this.ready;let r=await this.send("change",[e,t]);return this.outputHandler(r,e)}async modify(e,t){await this.ready;let r=await this.send("modify",[e,t]);return this.outputHandler(r,e)}async delete(e){await this.ready;let t=await this.send("delete",[e]);if(t.error)throw new Error(t.error.message)}send(e,t){return new Promise(r=>{if(!this.socket)throw new a;this.socket.send(e,t??[],i=>r(i))})}outputHandler(e,t){if(e.error)throw new Error(e.error.message);let r=t&&t.includes(":");if(Array.isArray(e.result))return r?e.result[0]:e.result;if("id"in(e.result??{}))return e.result;if(e.result===null)return r?void 0:[];throw console.debug(t,e),new l}resetReady(){this.ready=new Promise(e=>this.resolveReady=e)}};var w=class{constructor(e,{fetcher:t}={}){Object.defineProperty(this,"url",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"authorization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"namespace",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"database",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.fetch=t??fetch,this.url=h(e,{ws:"http",wss:"https"})}ready(){return!!(this.url&&this.namespace&&this.database)}setTokenAuth(e){this.authorization=`Bearer ${e}`}createRootAuth(e,t){this.authorization=`Basic ${btoa(`${e}:${t}`)}`}clearAuth(){this.authorization=void 0}use(e,t){this.namespace=e,this.database=t}async request(e,t){if(e=e.startsWith("/")?e.slice(1):e,!this.ready())throw new o;return(await this.fetch(`${this.url}/${e}`,{method:t?.method??"POST",headers:{"Content-Type":t?.plainBody?"text/plain":"application/json",Accept:"application/json",NS:this.namespace,DB:this.database,...this.authorization?{Authorization:this.authorization}:{}},body:typeof t?.body=="string"?t?.body:JSON.stringify(t?.body)})).json()}};var y=class{constructor(e,t={}){Object.defineProperty(this,"http",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ready",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"resolveReady",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.resolveReady=()=>{},this.ready=new Promise(r=>this.resolveReady=r),e&&this.connect(e,t)}async connect(e,{fetch:t,prepare:r}={}){this.http=new w(e,{fetcher:t}),await r?.(this),this.resolveReady(),await this.ready}close(){this.http=void 0,this.resetReady()}wait(){if(!this.http)throw new o;return this.ready}get status(){return this.request("/status")}async ping(){await this.request("/health")}use(e,t){if(!this.http)throw new o;return this.http.use(e,t)}async signup(e){let t=await this.request("/signup",{method:"POST",body:e});if(t.description)throw new Error(t.description);if(!t.token)throw new Error("Did not receive authentication token");return this.http?.setTokenAuth(t.token),t.token}async signin(e){let t=await this.request("/signin",{method:"POST",body:e});if(t.description)throw new Error(t.description);if(!t.token)this.http?.createRootAuth(e.user,e.pass);else return this.http?.setTokenAuth(t.token),t.token}authenticate(e){this.http?.setTokenAuth(e)}invalidate(){this.http?.clearAuth()}async query(e){await this.ready;let t=await this.request("/sql",{body:e,plainBody:!0,method:"POST"});if("information"in t)throw new Error(t.information);return t}get request(){if(!this.http)throw new o;return this.http.request}resetReady(){this.ready=new Promise(e=>this.resolveReady=e)}};var X=b;export{y as ExperimentalSurrealHTTP,b as Surreal,b as SurrealWebSocket,X as default};
//# sourceMappingURL=index.js.map
